include <%= ENV['TOOLS_DISTRIB'] %>/share/testsMakefile.include

CC         = $(RISCV_CC)
OBJCOPY    = $(RISCV_OBJCOPY)
# YES, we support M instructions in assembly tests
CFLAGS     = $(RISCV_CFLAGS_COMMON) -I$(RISCV_ASM_INCLUDES) -march=rv32im  -mabi=ilp32
LDFLAGS    = $(RISCV_LDFLAGS_COMMON)
LDSCRIPT   = $(RISCV_ASM_LD_SCRIPT)

SRC  = <%= input_asm %>

.PHONY : all

all: test.elf test.v tcl_copy

tcl_copy:
	cp $(TESTBENCH_TOOLS_SRC)/trace/filter_init.tcl filter_init.tcl

test.elf: asm_pre.s
	$(CC) -Xlinker -T$(RISCV_ASM_LD_SCRIPT) $(CFLAGS) asm_pre.s -o test.elf

asm_pre.s: $(SRC) $(RISCV_ASM_INCLUDES)/boot.S $(RISCV_ASM_INCLUDES)/defines.S
	$(CC) -x c -E $(CFLAGS) $(SRC) -o asm_pre.s

test.v: test.elf
	$(OBJCOPY) --target verilog test.elf test.v
