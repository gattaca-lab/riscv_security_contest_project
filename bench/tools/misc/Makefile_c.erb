include <%= ENV['TOOLS_DISTRIB'] %>/share/testsMakefile.include

CC         = $(RISCV_GCC_CC)
LD         = $(RISCV_GCC_LD)
NM         = $(RISCV_GCC_NM)
OBJCOPY    = $(RISCV_GCC_OBJCOPY)

LIBGCC_PATH = $(RISCV_LIBGCC_PATH)
LIBC_PATH   = $(RISCV_PSEUDOLIBC_PATH)
LIBC_INCLUDES = $(RISCV_PSEUDOLIBC_INCLUDES)

LDFLAGS    = $(RISCV_LDFLAGS_COMMON)
LDSCRIPT   = $(RISCV_C_LD_SCRIPT)

CFLAGS     = $(RISCV_CFLAGS_COMMON) <%= disable_warnings ? "-w" : "" %>
CFLAGS    += -march=$(MARCH_C_TESTS) -mabi=ilp32
<% if asm_c_ext %>
CFLAGS    += -march=rv32imc
<% end %>

LDFLAGS    = ${RISCV_LDFLAGS_COMMON} <%= disable_warnings ? "-w" : "" %>
LDFLAGS   += -march=$(MARCH_C_TESTS) -mabi=ilp32
<% if asm_c_ext %>
LDFLAGS   += -march=rv32imc
<% end %>

LIBC = <%= disable_security ? "c_ns" : "c" %>

SRC  = <%= input_c %>
DIRECTORY = <%= c_root %>
.PHONY : all

all: test.elf test.v tcl_copy

clean:
	rm test.elf
	rm test.v

tcl_copy: $(TESTBENCH_TOOLS_SRC)/trace/filter_init.tcl
	cp $(TESTBENCH_TOOLS_SRC)/trace/filter_init.tcl filter_init.tcl

test.elf:  command_line.s $(SRC) $(LIBC_PATH)/libc.a
	$(CC) $(CFLAGS) $(SRC) command_line.s \
	-I$(DIRECTORY) -I$(LIBC_INCLUDES) \
	-static -L$(LIBC_PATH) -lm -l$(LIBC) $(LIBGCC_PATH) \
	-Xlinker --defsym=__SOC_MEM_SIZE=$(SOC_RAM_SIZE) \
	-Xlinker -T$(LDSCRIPT) -o test.elf

test.v: test.elf
	$(OBJCOPY) --target verilog test.elf test.v
